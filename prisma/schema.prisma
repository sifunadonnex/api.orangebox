// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Company {
  id                String      @id @default(cuid())
  name              String      @unique
  email             String      @unique
  phone             String?
  address           String?
  country           String?
  logo              String?
  status            String      @default("active") // active, suspended, expired
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  users             User[]
  aircraft          Aircraft[]
}

model Subscription {
  id                    String      @id @default(cuid())
  planName              String      // Basic, Standard, Premium, Enterprise
  planType              String      // monthly, yearly
  maxUsers              Int         @default(5)
  maxAircraft           Int         @default(2)
  maxFlightsPerMonth    Int         @default(100)
  maxStorageGB          Int         @default(10)
  price                 Float
  currency              String      @default("USD")
  startDate             DateTime
  endDate               DateTime
  isActive              Boolean     @default(true)
  autoRenew             Boolean     @default(false)
  lastPaymentDate       DateTime?
  nextPaymentDate       DateTime?
  alertSentAt           DateTime?   // Track when suspension alert was sent
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  companies             Company[]
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  role            String        @default("user") // admin, fda, gatekeeper, user
  fullName        String?
  designation     String?
  department      String?
  username        String?
  password        String?
  image           String?
  phone           String?
  isActive        Boolean       @default(true)
  companyId       String?
  company         Company?      @relation(fields: [companyId], references: [id])
  lastLoginAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  notifications   Notification[]
  sessions        Session[]     // User's active sessions for single-device login
}

// Session model for single-device login enforcement
model Session {
  id              String        @id @default(cuid())
  userId          String
  token           String        @unique
  deviceInfo      String?       // User-Agent info
  ipAddress       String?       // Client IP address
  isActive        Boolean       @default(true)
  expiresAt       DateTime
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model Csv {
  id        String      @id @default(cuid())
  name      String
  file      String
  status    String?
  departure String?
  pilot     String?
  destination String?
  flightHours String?
  aircraftId String     // Corrected field name
  aircraft  Aircraft @relation(fields: [aircraftId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Exceedance Exceedance[]
}

model Aircraft {
  id           String          @id @default(cuid())
  airline      String
  aircraftMake String
  modelNumber  String?
  serialNumber String
  registration String?
  companyId    String
  parameters   String?
  company      Company      @relation(fields: [companyId], references: [id])
  csv          Csv[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  Flight       Flight[]
  EventLog     EventLog[]
  Exceedance   Exceedance[]
}

model Flight {
  id         String      @id @default(cuid())
  name       String
  aircraftId String
  aircraft   Aircraft @relation(fields: [aircraftId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model EventLog {
  id              String      @id @default(cuid())
  eventName       String?
  displayName     String
  eventCode       String
  eventDescription String
  eventParameter  String
  eventTrigger    String
  eventType       String
  flightPhase     String
  high            String?
  high1           String?
  high2           String?
  low             String?
  low1            String?
  low2            String?
  triggerType     String?
  detectionPeriod String?
  severities      String?
  sop             String
  aircraftId      String
  exceedance     Exceedance[]
  aircraft        Aircraft @relation(fields: [aircraftId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Exceedance {
  id              String      @id @default(cuid())
  exceedanceValues String
  flightPhase     String
  parameterName   String
  description     String
  eventStatus     String 
  aircraftId      String
  flightId        String
  file            String?
  eventId         String?
  comment	  String?
  exceedanceLevel String?
  eventlog        EventLog? @relation(fields: [eventId], references: [id])
  aircraft        Aircraft @relation(fields: [aircraftId], references: [id])
  csv             Csv @relation(fields: [flightId], references: [id])
  notifications   Notification[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Notification {
  id              String      @id @default(cuid())
  userId          String      // User to notify
  exceedanceId    String      // Reference to the exceedance
  message         String
  level           String      // Level 1, 2, or 3
  isRead          Boolean     @default(false)
  user            User        @relation(fields: [userId], references: [id])
  exceedance      Exceedance  @relation(fields: [exceedanceId], references: [id])
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}
